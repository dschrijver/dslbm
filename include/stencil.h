#ifndef STENCIL_H
#define STENCIL_H

#include <string.h>
#include <math.h>

#include "datatypes.h"
#include "memory.h"

static inline void initialize_stencil(SimulationBag *sim)
{
    Stencil *stencil = sim->stencil;
    ParamBag *params = sim->params;

    stencil->NP = 19;

    allocate_stencil(sim);

    stencil->cs2 = 1.0 / 3.0;

    int cx[] = {0, 1, -1, 0, 0, 0, 0, 1, -1, 1, -1, 1, -1, 1, -1, 0, 0, 0, 0};
    int cy[] = {0, 0, 0, 1, -1, 0, 0, 1, 1, -1, -1, 0, 0, 0, 0, 1, -1, 1, -1};
    int cz[] = {0, 0, 0, 0, 0, 1, -1, 0, 0, 0, 0, 1, 1, -1, -1, 1, 1, -1, -1};
    double wp[] = {1.0 / 3.0, 1.0 / 18.0, 1.0 / 18.0, 1.0 / 18.0, 1.0 / 18.0, 1.0 / 18.0, 1.0 / 18.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0, 1.0 / 36.0};
    int p_bounceback[] = {0, 2, 1, 4, 3, 6, 5, 10, 9, 8, 7, 14, 13, 12, 11, 18, 17, 16, 15};

    memcpy(stencil->cx, cx, stencil->NP * sizeof(int));
    memcpy(stencil->cy, cy, stencil->NP * sizeof(int));
    memcpy(stencil->cz, cz, stencil->NP * sizeof(int));
    memcpy(stencil->wp, wp, stencil->NP * sizeof(double));
    memcpy(stencil->p_bounceback, p_bounceback, stencil->NP * sizeof(int));

    double M[19][19] = {
        {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
        {-30.0, -11.0, -11.0, -11.0, -11.0, -11.0, -11.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0},
        {12.0, -4.0, -4.0, -4.0, -4.0, -4.0, -4.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
        {0.0, 1.0, -1.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0, -1.0, 1.0, -1.0, 1.0, -1.0, 0.0, 0.0, 0.0, 0.0},
        {0.0, -4.0, 4.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0, -1.0, 1.0, -1.0, 1.0, -1.0, 0.0, 0.0, 0.0, 0.0},
        {0.0, 0.0, 0.0, 1.0, -1.0, 0.0, 0.0, 1.0, 1.0, -1.0, -1.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0, -1.0},
        {0.0, 0.0, 0.0, -4.0, 4.0, 0.0, 0.0, 1.0, 1.0, -1.0, -1.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0, -1.0},
        {0.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, -1.0, -1.0, 1.0, 1.0, -1.0, -1.0},
        {0.0, 0.0, 0.0, 0.0, 0.0, -4.0, 4.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, -1.0, -1.0, 1.0, 1.0, -1.0, -1.0},
        {0.0, 2.0, 2.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -2.0, -2.0, -2.0, -2.0},
        {0.0, -4.0, -4.0, 2.0, 2.0, 2.0, 2.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -2.0, -2.0, -2.0, -2.0},
        {0.0, 0.0, 0.0, 1.0, 1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 0.0, 0.0, 0.0, 0.0},
        {0.0, 0.0, 0.0, -2.0, -2.0, 2.0, 2.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 0.0, 0.0, 0.0, 0.0},
        {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, -1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
        {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, -1.0, 1.0},
        {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, -1.0, 1.0, 0.0, 0.0, 0.0, 0.0},
        {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 0.0, 0.0, 0.0, 0.0},
        {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.0, -1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, -1.0, 1.0, -1.0},
        {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, 1.0}};
    double M_inv[19][19] = {
        {1.0 / 19.0, -5.0 / 399.0, 1.0 / 21.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
        {1.0 / 19.0, -11.0 / 2394.0, -1.0 / 63.0, 1.0 / 10.0, -1.0 / 10.0, 0.0, 0.0, 0.0, 0.0, 1.0 / 18.0, -1.0 / 18.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
        {1.0 / 19.0, -11.0 / 2394.0, -1.0 / 63.0, -1.0 / 10.0, 1.0 / 10.0, 0.0, 0.0, 0.0, 0.0, 1.0 / 18.0, -1.0 / 18.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
        {1.0 / 19.0, -11.0 / 2394.0, -1.0 / 63.0, 0.0, 0.0, 1.0 / 10.0, -1.0 / 10.0, 0.0, 0.0, -1.0 / 36.0, 1.0 / 36.0, 1.0 / 12.0, -1.0 / 12.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
        {1.0 / 19.0, -11.0 / 2394.0, -1.0 / 63.0, 0.0, 0.0, -1.0 / 10.0, 1.0 / 10.0, 0.0, 0.0, -1.0 / 36.0, 1.0 / 36.0, 1.0 / 12.0, -1.0 / 12.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
        {1.0 / 19.0, -11.0 / 2394.0, -1.0 / 63.0, 0.0, 0.0, 0.0, 0.0, 1.0 / 10.0, -1.0 / 10.0, -1.0 / 36.0, 1.0 / 36.0, -1.0 / 12.0, 1.0 / 12.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
        {1.0 / 19.0, -11.0 / 2394.0, -1.0 / 63.0, 0.0, 0.0, 0.0, 0.0, -1.0 / 10.0, 1.0 / 10.0, -1.0 / 36.0, 1.0 / 36.0, -1.0 / 12.0, 1.0 / 12.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, 1.0 / 10.0, 1.0 / 40.0, 1.0 / 10.0, 1.0 / 40.0, 0.0, 0.0, 1.0 / 36.0, 1.0 / 72.0, 1.0 / 12.0, 1.0 / 24.0, 1.0 / 4.0, 0.0, 0.0, 1.0 / 8.0, -1.0 / 8.0, 0.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, -1.0 / 10.0, -1.0 / 40.0, 1.0 / 10.0, 1.0 / 40.0, 0.0, 0.0, 1.0 / 36.0, 1.0 / 72.0, 1.0 / 12.0, 1.0 / 24.0, -1.0 / 4.0, 0.0, 0.0, -1.0 / 8.0, -1.0 / 8.0, 0.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, 1.0 / 10.0, 1.0 / 40.0, -1.0 / 10.0, -1.0 / 40.0, 0.0, 0.0, 1.0 / 36.0, 1.0 / 72.0, 1.0 / 12.0, 1.0 / 24.0, -1.0 / 4.0, 0.0, 0.0, 1.0 / 8.0, 1.0 / 8.0, 0.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, -1.0 / 10.0, -1.0 / 40.0, -1.0 / 10.0, -1.0 / 40.0, 0.0, 0.0, 1.0 / 36.0, 1.0 / 72.0, 1.0 / 12.0, 1.0 / 24.0, 1.0 / 4.0, 0.0, 0.0, -1.0 / 8.0, 1.0 / 8.0, 0.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, 1.0 / 10.0, 1.0 / 40.0, 0.0, 0.0, 1.0 / 10.0, 1.0 / 40.0, 1.0 / 36.0, 1.0 / 72.0, -1.0 / 12.0, -1.0 / 24.0, 0.0, 0.0, 1.0 / 4.0, -1.0 / 8.0, 0.0, 1.0 / 8.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, -1.0 / 10.0, -1.0 / 40.0, 0.0, 0.0, 1.0 / 10.0, 1.0 / 40.0, 1.0 / 36.0, 1.0 / 72.0, -1.0 / 12.0, -1.0 / 24.0, 0.0, 0.0, -1.0 / 4.0, 1.0 / 8.0, 0.0, 1.0 / 8.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, 1.0 / 10.0, 1.0 / 40.0, 0.0, 0.0, -1.0 / 10.0, -1.0 / 40.0, 1.0 / 36.0, 1.0 / 72.0, -1.0 / 12.0, -1.0 / 24.0, 0.0, 0.0, -1.0 / 4.0, -1.0 / 8.0, 0.0, -1.0 / 8.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, -1.0 / 10.0, -1.0 / 40.0, 0.0, 0.0, -1.0 / 10.0, -1.0 / 40.0, 1.0 / 36.0, 1.0 / 72.0, -1.0 / 12.0, -1.0 / 24.0, 0.0, 0.0, 1.0 / 4.0, 1.0 / 8.0, 0.0, -1.0 / 8.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, 0.0, 0.0, 1.0 / 10.0, 1.0 / 40.0, 1.0 / 10.0, 1.0 / 40.0, -1.0 / 18.0, -1.0 / 36.0, 0.0, 0.0, 0.0, 1.0 / 4.0, 0.0, 0.0, 1.0 / 8.0, -1.0 / 8.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, 0.0, 0.0, -1.0 / 10.0, -1.0 / 40.0, 1.0 / 10.0, 1.0 / 40.0, -1.0 / 18.0, -1.0 / 36.0, 0.0, 0.0, 0.0, -1.0 / 4.0, 0.0, 0.0, -1.0 / 8.0, -1.0 / 8.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, 0.0, 0.0, 1.0 / 10.0, 1.0 / 40.0, -1.0 / 10.0, -1.0 / 40.0, -1.0 / 18.0, -1.0 / 36.0, 0.0, 0.0, 0.0, -1.0 / 4.0, 0.0, 0.0, 1.0 / 8.0, 1.0 / 8.0},
        {1.0 / 19.0, 4.0 / 1197.0, 1.0 / 252.0, 0.0, 0.0, -1.0 / 10.0, -1.0 / 40.0, -1.0 / 10.0, -1.0 / 40.0, -1.0 / 18.0, -1.0 / 36.0, 0.0, 0.0, 0.0, 1.0 / 4.0, 0.0, 0.0, -1.0 / 8.0, 1.0 / 8.0}};
    double omega_RED[19];
    double omega_BLUE[19];
    omega_RED[0] = params->s_rho_RED;
    omega_BLUE[0] = params->s_rho_BLUE;
    omega_RED[1] = params->s_e_RED;
    omega_BLUE[1] = params->s_e_BLUE;
    omega_RED[2] = params->s_eps_RED;
    omega_BLUE[2] = params->s_eps_BLUE;
    omega_RED[3] = params->s_j_RED;
    omega_BLUE[3] = params->s_j_BLUE;
    omega_RED[4] = params->s_q_RED;
    omega_BLUE[4] = params->s_q_BLUE;
    omega_RED[5] = params->s_j_RED;
    omega_BLUE[5] = params->s_j_BLUE;
    omega_RED[6] = params->s_q_RED;
    omega_BLUE[6] = params->s_q_BLUE;
    omega_RED[7] = params->s_j_RED;
    omega_BLUE[7] = params->s_j_BLUE;
    omega_RED[8] = params->s_q_RED;
    omega_BLUE[8] = params->s_q_BLUE;
    omega_RED[9] = 1.0 / params->tau_RED;
    omega_BLUE[9] = 1.0 / params->tau_BLUE;
    omega_RED[10] = params->s_pi_RED;
    omega_BLUE[10] = params->s_pi_BLUE;
    omega_RED[11] = 1.0 / params->tau_RED;
    omega_BLUE[11] = 1.0 / params->tau_BLUE;
    omega_RED[12] = params->s_pi_RED;
    omega_BLUE[12] = params->s_pi_BLUE;
    omega_RED[13] = 1.0 / params->tau_RED;
    omega_BLUE[13] = 1.0 / params->tau_BLUE;
    omega_RED[14] = 1.0 / params->tau_RED;
    omega_BLUE[14] = 1.0 / params->tau_BLUE;
    omega_RED[15] = 1.0 / params->tau_RED;
    omega_BLUE[15] = 1.0 / params->tau_BLUE;
    omega_RED[16] = params->s_m_RED;
    omega_BLUE[16] = params->s_m_BLUE;
    omega_RED[17] = params->s_m_RED;
    omega_BLUE[17] = params->s_m_BLUE;
    omega_RED[18] = params->s_m_RED;
    omega_BLUE[18] = params->s_m_BLUE;

    memcpy(stencil->M, (double *)M, stencil->NP * stencil->NP * sizeof(double));
    memcpy(stencil->M_inv, (double *)M_inv, stencil->NP * stencil->NP * sizeof(double));
    memcpy(stencil->omega[RED], omega_RED, stencil->NP * sizeof(double));
    memcpy(stencil->omega[BLUE], omega_BLUE, stencil->NP * sizeof(double));

    stencil->zeta = 0.5;
    double B[] = {-2.0 / 9.0, 1.0 / 54.0, 1.0 / 54.0, 1.0 / 54.0, 1.0 / 54.0, 1.0 / 54.0, 1.0 / 54.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0, 1.0 / 27.0};
    double phi_eq_RED[19] = {0.0};
    double phi_eq_BLUE[19] = {0.0};
    for (int p = 0; p < stencil->NP; p++)
    {
        if (p == 0)
        {
            phi_eq_RED[p] = params->alpha_RED;
            phi_eq_BLUE[p] = params->alpha_BLUE;
        }
        else if ((p >= 1) && (p <= 6))
        {
            phi_eq_RED[p] = (1.0 - params->alpha_RED) / 12.0;
            phi_eq_BLUE[p] = (1.0 - params->alpha_BLUE) / 12.0;
        }
        else
        {
            phi_eq_RED[p] = (1.0 - params->alpha_RED) / 24.0;
            phi_eq_BLUE[p] = (1.0 - params->alpha_BLUE) / 24.0;
        }
    }

    memcpy(stencil->B, B, stencil->NP * sizeof(double));
    memcpy(stencil->phi_eq[RED], phi_eq_RED, stencil->NP * sizeof(double));
    memcpy(stencil->phi_eq[BLUE], phi_eq_BLUE, stencil->NP * sizeof(double));

    stencil->C_norm = 3.0 / 18.0;
    stencil->C_par = 1.0 / 18.0;
}

#endif